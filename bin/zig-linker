#!/usr/bin/env python3

import re
import sys
import subprocess

def extract_target(invocation):
	PREFIX = "zig-"
	prefix_index = invocation.find(PREFIX)
	if prefix_index >= 0:
		return invocation[prefix_index + len(PREFIX):]
	
	raise RuntimeError(f"Unknown invocation format - cannot extract target \"{invocation}\"")

def remove_crti(args):
	return filter(
		lambda arg: not (arg.endswith("musl/lib/self-contained/rcrt1.o") or arg.endswith("musl/lib/self-contained/crti.o")),
		args
	)

def handle_lgcc_s(args):
	return map(
		lambda arg: "-lunwind" if arg == "-lgcc_s" else arg,
		args
	)

target = extract_target(sys.argv[0])
args = sys.argv[1:]
if "musl" in target:
	args = remove_crti(args)
args = handle_lgcc_s(args)

p = subprocess.run(["zig", "cc", "-target", target] + list(args), check = True)
